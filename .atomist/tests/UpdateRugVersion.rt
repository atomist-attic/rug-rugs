/*
 * Copyright Â© 2016 Atomist, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

scenario UpdateRugVersion should update the version in a manifest.yml

let v = "7.4.3"

given
  ".atomist/manifest.yml" = """group: test-rugs
artifact: test-manifest
version: "0.1.0"
requires: "[0.6.0,1.0.0)"
dependencies:
extensions:
"""

when
  UpdateRugVersion manifest_version = v, package_version = "~11.9.2"

then
  fileContains ".atomist/manifest.yml" { 'requires: "' + v + '"' }
    and { !result.fileContains(".atomist/manifest.yml", "0.6.0") }
    and { !result.fileContains(".atomist/manifest.yml", "11.9.2") }


scenario UpdateRugVersion should update to version range in a manifest.yml

let v = "[7.4.3,13.11.2)"

given
  ".atomist/manifest.yml" = """group: test-rugs
artifact: test-manifest
version: "0.1.0"
requires: "[0.6.0,1.0.0)"
dependencies:
extensions:
"""

when
  UpdateRugVersion manifest_version = v, package_version = "~11.9.2"

then
  fileContains ".atomist/manifest.yml" { 'requires: "' + v + '"' }
    and { !result.fileContains(".atomist/manifest.yml", "0.6.0") }
    and { !result.fileContains(".atomist/manifest.yml", "11.9.2") }


scenario UpdateRugVersion should update the version in a package.json

let v = "7.4.3"

given
  ".atomist/package.json" = """{
  "name": "@atomist-rugs/rug-tests",
  "version": "0.1.0",
  "description": "Editors for Rug Tests",
  "keywords": [
    "Atomist",
    "Rug"
  ],
  "author": "Atomist, Inc",
  "license": "Apache-2.0",
  "repository": {
    "type": "git",
    "url": "https://github.com/atomist-rugs/rug-tests.git"
  },
  "bugs": {
    "url": "https://github.com/atomist-rugs/rug-tests/issues"
  },
  "homepage": "https://github.com/atomist-rugs/rug-tests",
  "dependencies": {
    "@atomist/rug": "0.6.0",
    "@college/dtc": "^3.5.7"
  },
  "scripts": {
    "rug-install": "rug install -urqX",
    "rug-test": "rug test -urqX",
    "rug-publish": "rug publish -urqX"
  }
}
"""

when
  UpdateRugVersion manifest_version = v, package_version = "~11.9.2"

then
  fileContains ".atomist/package.json" { '"@atomist/rug": "~11.9.2"' }
    and fileContains ".atomist/package.json" { '"@college/dtc": "^3.5.7"' }
    and { !result.fileContains(".atomist/package.json", "0.6.0") }
    and { !result.fileContains(".atomist/package.json", v) }


scenario UpdateRugVersion should update the version in a squashed package.json

let v = "7.4.3"

given
  ".atomist/package.json" = """{"name":"@atomist-rugs/rug-tests","version":"0.1.0","description":"Editors for Rug Tests","keywords":["Atomist","Rug"],"author":"Atomist, Inc","license":"Apache-2.0","repository":{"type":"git","url":"https://github.com/atomist-rugs/rug-tests.git"},"bugs":{"url":"https://github.com/atomist-rugs/rug-tests/issues"},"homepage":"https://github.com/atomist-rugs/rug-tests","dependencies":{"@atomist/rug":"0.6.0","@college/dtc": "^3.5.7"},"scripts":{"rug-install":"rug install -urqX","rug-test":"rug test -urqX","rug-publish":"rug publish -urqX"}}"""

when
  UpdateRugVersion manifest_version = v, package_version = "~11.9.2"

then
  fileContains ".atomist/package.json" { '"@atomist/rug": "~11.9.2"' }
    and fileContains ".atomist/package.json" { '"@college/dtc": "^3.5.7"' }
    and { !result.fileContains(".atomist/package.json", "0.6.0") }
    and { !result.fileContains(".atomist/package.json", v) }


scenario UpdateRugVersion should do nothing if not a Rug Archive project

let v = "13.11.2"

given
  Empty

when
  UpdateRugVersion manifest_version = v, package_version = "~11.9.2"

then
  NoChange
